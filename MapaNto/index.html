<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MapaNto</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FAVICON: coloque seu arquivo aqui com nome favicon.png na mesma pasta -->
  <link rel="icon" type="image/png" href="../MapaNto/pardinilogo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../MapaNto/pardinilogo.png">
  <meta name="theme-color" content="#F3F0EC">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .printer-point { position: absolute; width: 24px; height: 24px; border-radius: 9999px; cursor: pointer; transition: all 0.25s ease; display:flex; align-items:center; justify-content:center; transform:translate(-50%,-50%); z-index:20; }
    .printer-point::before { content:''; position:absolute; width:100%; height:100%; border-radius:9999px; animation:pulse 2s infinite; background-color: currentColor; opacity:0.75; }
    .printer-point:hover { transform: translate(-50%, -50%) scale(1.25); z-index:25; }
    .printer-point-icon{ width:14px; height:14px; color:white; z-index:30; }
    @keyframes pulse { 0%{transform:scale(0.95);}70%{transform:scale(1);}100%{transform:scale(0.95);} }
    .highlighted { transform: translate(-50%, -50%) scale(1.6) !important; z-index:60 !important; transition: transform .2s ease; }
    .highlighted::before { animation: highlight-pulse 1s infinite !important; background-color: rgba(59,130,246,0.95) !important; }
    @keyframes highlight-pulse { 0%{box-shadow:0 0 0 0 rgba(59,130,246,0.8);}70%{box-shadow:0 0 0 18px rgba(59,130,246,0);}100%{box-shadow:0 0 0 0 rgba(59,130,246,0);} }
    .icon-hitbox { display:inline-flex; align-items:center; justify-content:center; padding:8px; border-radius:9999px; cursor:pointer; -webkit-tap-highlight-color: transparent; }
    .modal-backdrop { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index:40; display:flex; align-items:center; justify-content:center; }
    .modal-content { z-index:50; }
    #map-container.add-mode { cursor:crosshair; }
    .toast { position: fixed; top:20px; right:20px; background:#3D405B; color:white; padding:12px 20px; border-radius:8px; z-index:100; opacity:0; transform: translateY(-20px); transition: opacity .5s, transform .5s; }
    .toast.show { opacity:1; transform:translateY(0); }
    #map-tooltip { position:absolute; background:#3D405B; color:white; padding:8px 12px; border-radius:6px; font-size:.875rem; line-height:1.4; opacity:0; visibility:hidden; transition:opacity .15s, visibility .15s; pointer-events:none; z-index:60; transform: translate(-50%,-125%); white-space:nowrap; }
    #map-tooltip.show { opacity:1; visibility:visible; }
    .focus-label { position:absolute; transform: translate(-50%,-120%); background: rgba(255,255,255,0.95); border-radius:6px; padding:6px 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.15); z-index:90; font-weight:600; white-space:nowrap; }
    #map-inner { position: relative; width: 100%; height: 100%; transform-origin: 0 0; transition: transform 450ms cubic-bezier(.2,.9,.3,1); }
    #search-input { transition: width 300ms ease-in-out; width: 0; padding-left: 0; padding-right: 0; }
    #search-container.expanded #search-input { width: 250px; padding-left: 1rem; padding-right: 0.5rem; }
    #search-results { position: absolute; top: 110%; right: 0; width: 300px; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 100; max-height: 300px; overflow-y: auto; display: none; }
    .result-item:hover { background-color: #f0f0f0; }
  </style>
</head>
<body class="bg-[#F3F0EC] text-[#3D405B]">
  <div id="side-actions" class="fixed top-4 right-4 z-30 flex flex-col items-end gap-3">
    <div id="search-container" class="relative flex items-center justify-end bg-white rounded-full shadow-md">
      <form id="search-form" class="flex items-center">
        <input id="search-input" type="text" placeholder="Buscar por Nome ou SELB..." class="h-12 border-none rounded-l-full focus:ring-0 bg-transparent">
        <div id="search-hitbox" class="icon-hitbox" title="Buscar">
            <button type="button" id="search-icon-btn" class="w-10 h-10 flex items-center justify-center text-gray-600" aria-label="Buscar">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </button>
        </div>
      </form>
      <div id="search-results" aria-hidden="true"></div>
    </div>
    <div id="add-hitbox" class="icon-hitbox bg-white rounded-full shadow-md" title="Adicionar impressora">
      <button id="add-printer-btn" class="w-12 h-12 bg-[#81B29A] text-white rounded-full shadow-md hover:bg-[#6a947e] transition-colors text-2xl font-bold flex items-center justify-center">+</button>
    </div>
  </div>

  <div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-6">
        <h1 class="text-3xl md:text-4xl font-bold">Mapeamento de Impressoras Térmicas</h1>
    </header>
    <main>
      <div id="map-container" 
           class="relative mx-auto shadow-2xl rounded-lg overflow-hidden border-4 border-transparent transition-colors duration-300" 
           style="width: min(3840px, 92vw); aspect-ratio: 3840 / 2715;">
        <div id="map-inner" class="relative w-full h-full">
          <img id="map-image" src="plantanto.jpg" alt="Planta do escritório" 
               class="w-full h-full object-contain bg-white" 
               onerror="this.onerror=null;this.src='https://placehold.co/3840x2715/ffffff/cccccc?text=Planta+Indispon%C3%ADvel';">
        </div>
        <div id="map-tooltip"></div>
      </div>
    </main>
  </div>

  <div id="details-modal" class="modal-backdrop hidden">
    <div class="modal-content bg-white w-11/12 max-w-md mx-auto rounded-lg shadow-xl p-6 relative">
      <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-800">✕</button>
      <h2 id="modal-title" class="text-2xl font-bold mb-4"></h2>
      <div class="space-y-3 text-gray-700">
        <p><strong>Departamento:</strong> <span id="modal-department"></span></p>
        <p><strong>SELB:</strong> <span id="modal-selb" class="font-mono bg-gray-100 px-2 py-1 rounded"></span></p>
        <p><strong>Endereço IP:</strong> <span id="modal-ip" class="font-mono bg-gray-100 px-2 py-1 rounded"></span></p>
        <p><strong>Estado:</strong> <span id="modal-status"></span></p>
      </div>
      <div class="mt-6 grid grid-cols-2 gap-3">
        <a id="modal-link" href="#" target="_blank" class="col-span-1 text-center px-4 py-3 bg-[#E07A5F] text-white rounded-lg hover:bg-opacity-90 transition-colors">Acessar IP</a>
        <button id="edit-printer-btn" class="col-span-1 px-4 py-3 bg-[#3D405B] text-white rounded-lg hover:bg-opacity-90 transition-colors">Editar</button>
        <button id="reposition-printer-btn" class="col-span-1 px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-opacity-90 transition-colors">Reposicionar</button>
        <button id="delete-printer-btn" class="col-span-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Remover</button>
      </div>
      <div id="modal-note" class="text-xs text-gray-500 mt-4 text-center"></div>
    </div>
  </div>

  <div id="add-modal" class="modal-backdrop hidden">
    <div class="modal-content bg-white w-11/12 max-w-md mx-auto rounded-lg shadow-xl p-6 relative">
      <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-800">✕</button>
      <h2 id="add-modal-title" class="text-2xl font-bold mb-4">Adicionar Nova Impressora</h2>
      <form id="add-printer-form" class="space-y-4">
        <input name="name" placeholder="Nome (Ex: Recepção P&B)" required class="w-full p-3 border rounded focus:ring-2 focus:ring-[#3D405B]">
        <input name="department" placeholder="Departamento" required class="w-full p-3 border rounded focus:ring-2 focus:ring-[#3D405B]">
        <input name="selb" placeholder="SELB (Ex: 98765)" required class="w-full p-3 border rounded focus:ring-2 focus:ring-[#3D405B]">
        <input name="ip" placeholder="Endereço IP (Ex: 192.168.1.25)" required class="w-full p-3 border rounded focus:ring-2 focus:ring-[#3D405B]">
        <div class="flex items-center justify-between gap-2">
          <button type="submit" id="add-submit-btn" class="flex-1 px-6 py-3 bg-[#3D405B] text-white rounded-lg hover:bg-opacity-90 transition-colors">Salvar Impressora</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast-notification" class="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const mapContainer = document.getElementById('map-container');
  const mapInner = document.getElementById('map-inner');
  const tooltip = document.getElementById('map-tooltip');
  const addPrinterBtn = document.getElementById('add-printer-btn');
  const addHitbox = document.getElementById('add-hitbox');
  const searchContainer = document.getElementById('search-container');
  const searchHitbox = document.getElementById('search-hitbox');
  const searchForm = document.getElementById('search-form');
  const searchInput = document.getElementById('search-input');
  const searchResultsPanel = document.getElementById('search-results');
  const detailsModal = document.getElementById('details-modal');
  const addModal = document.getElementById('add-modal');
  const addPrinterForm = document.getElementById('add-printer-form');
  const deletePrinterBtn = document.getElementById('delete-printer-btn');
  const modalNote = document.getElementById('modal-note');
  const editPrinterBtn = document.getElementById('edit-printer-btn');
  const repositionPrinterBtn = document.getElementById('reposition-printer-btn');
  const addModalTitle = document.getElementById('add-modal-title');
  const addSubmitBtn = document.getElementById('add-submit-btn');

  let printerData = [];
  let isAddMode = false;
  let newPrinterCoords = { top: '50%', left: '50%' };
  let printerToDeleteSelb = null;
  let transientLabel = null;
  let focusResetTimer = null;
  let repositionTargetSelb = null; // quando setado, clique no mapa reposiciona essa impressora

  const initialPrinters = [

  // adicionados
  { name:'CDA00030', department:'Customer Service', ip:'172.19.114.30', selb:'1LG9', status:'Offline', pos:{top:'11.914484746576989%', left:'68.37635869565217%'} },
  { name:'NCS14224', department:'Customer Service', ip:'172.19.114.224', selb:'OJL4', status:'Desconhecido', pos:{top:'16.814797021378812%', left:'68.51222826086956%'} }
];


  function showToast(msg){ const t=document.getElementById('toast-notification'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
  function savePrinters(){ localStorage.setItem('interactiveMapPrinters', JSON.stringify(printerData)); }
  function loadPrinters(){ const s=localStorage.getItem('interactiveMapPrinters'); printerData = s ? JSON.parse(s) : initialPrinters; renderAllPrinters(); }
  function getStatusColor(status){
    switch((status||'').toLowerCase()){
      case 'online': return 'bg-green-500';
      case 'manutenção': return 'bg-yellow-500';
      case 'offline': return 'bg-red-500';
      default: return 'bg-gray-500';
    }
  }

  function createPrinterPoint(printer){
    const point = document.createElement('button');
    point.className = `printer-point ${getStatusColor(printer.status)}`;
    point.style.top = printer.pos.top;
    point.style.left = printer.pos.left;
    point.dataset.printerSelb = printer.selb;
    point.setAttribute('aria-label', `Impressora ${printer.name}`);
    point.innerHTML = `<svg class="printer-point-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>`;

    point.addEventListener('click', (e) => {
      const selb = e.currentTarget.dataset.printerSelb;
      const current = printerData.find(p => p.selb === selb);
      if (!current) return;
      showDetailsModal(current);
      checkPrinterReachabilityAndUpdate(current);
    });

    point.addEventListener('mouseenter', (e) => {
      const selb = e.currentTarget.dataset.printerSelb;
      const current = printerData.find(p => p.selb === selb) || printer;
      tooltip.innerHTML = `<strong>${current.name}</strong><br>SELB: ${current.selb}`;
      const pointRect = e.currentTarget.getBoundingClientRect();
      const containerRect = mapContainer.getBoundingClientRect();
      tooltip.style.top = `${pointRect.top - containerRect.top}px`; 
      tooltip.style.left = `${pointRect.left - containerRect.left}px`;
      tooltip.classList.add('show');
    });
    point.addEventListener('mouseleave', () => tooltip.classList.remove('show'));

    mapInner.appendChild(point);
  }

  function renderAllPrinters(){ mapInner.querySelectorAll('.printer-point').forEach(n=>n.remove()); printerData.forEach(createPrinterPoint); }

  function showDetailsModal(printer){
    document.getElementById('modal-title').textContent = printer.name;
    document.getElementById('modal-department').textContent = printer.department;
    document.getElementById('modal-selb').textContent = printer.selb;
    document.getElementById('modal-ip').textContent = printer.ip;
    printerToDeleteSelb = printer.selb;

    const statusContainer = document.getElementById('modal-status');
    statusContainer.innerHTML = `<span id="modal-status-span" class="font-semibold text-gray-600">Verificando... <svg class="w-4 h-4 inline-block animate-spin ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2v4m0 12v4m-9-9h4m12 0h4m-2.8-7.2l-3 3m-4.4 4.4l-3 3m0-10.4l3 3m4.4 4.4l3 3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>`;

    modalNote.textContent = '';
    if (location.protocol === 'https:' && !isLocalHostEnvironment()) {
      modalNote.textContent = 'Nota: A verificação de status pode ser bloqueada pelo navegador em páginas HTTPS. Para maior precisão, aceda via HTTP ou localhost.';
    }

    document.getElementById('modal-link').href = `http://${printer.ip}`;
    detailsModal.classList.remove('hidden');
  }
  
  function isLocalHostEnvironment(){
    const host = location.hostname;
    return location.protocol === 'file:' || host === 'localhost' || host === '127.0.0.1' || host === '' || /^(10\.|192\.168\.|172\.(1[6-9]|2\d|3[0-1]))/.test(host);
  }

  async function pingHost(ip, timeout = 2200) {
    if (!ip) return false;
    const cacheBuster = `?_=${Date.now()}`;
    const protocols = location.protocol === 'https:' ? ['https'] : ['https', 'http'];
    const ports = [443, 80, 9100, 631];
    const paths = ['/favicon.ico', '/', '/status'];
    
    const candidates = [];
    for (const proto of protocols) {
        for (const port of ports) {
            for (const path of paths) {
                const portPart = (port === 80 && proto === 'http') || (port === 443 && proto === 'https') ? '' : `:${port}`;
                candidates.push(`${proto}://${ip}${portPart}${path}${cacheBuster}`);
            }
        }
    }

    const tryFetch = (url) => new Promise((resolve, reject) => {
        const controller = new AbortController();
        const timer = setTimeout(() => { controller.abort(); reject(new Error('timeout')); }, timeout);
        fetch(url, { method: 'HEAD', mode: 'no-cors', cache: 'no-store', signal: controller.signal })
            .then(() => resolve(true))
            .catch(reject)
            .finally(() => clearTimeout(timer));
    });

    const tryImage = (url) => new Promise((resolve, reject) => {
        const img = new Image();
        let done = false;
        const timer = setTimeout(() => { if (!done) { done = true; reject(new Error('timeout')); } }, timeout);
        img.onload = () => { if (!done) { done = true; clearTimeout(timer); resolve(true); } };
        img.onerror = () => { if (!done) { done = true; clearTimeout(timer); reject(new Error('error')); } };
        img.src = url;
    });

    const attempts = candidates.flatMap(url => [() => tryFetch(url), () => tryImage(url)]);

    for (const attempt of attempts) {
        try {
            if (await attempt()) return true;
        } catch (e) { /* continue */ }
    }
    return false;
  }

  async function checkPrinterReachabilityAndUpdate(printer) {
    const current = printerData.find(p => p.selb === printer.selb) || printer;
    current.status = current.status || 'Desconhecido';
    savePrinters();

    const reachable = await pingHost(current.ip);
    current.status = reachable ? 'Online' : 'Offline';
    savePrinters();

    const point = document.querySelector(`.printer-point[data-printer-selb="${current.selb}"]`);
    if (point) {
      const hadHighlight = point.classList.contains('highlighted');
      point.className = `printer-point ${getStatusColor(current.status)}`;
      if (hadHighlight) point.classList.add('highlighted');
    }

    const modalStatusSpan = document.getElementById('modal-status-span');
    if (modalStatusSpan && printerToDeleteSelb === current.selb && !detailsModal.classList.contains('hidden')) {
      const statusContainer = document.getElementById('modal-status');
      const statusText = current.status || 'Desconhecido';
      let statusColorClass = 'text-gray-600';
      if (statusText === 'Online') statusColorClass = 'text-green-600';
      if (statusText === 'Offline') statusColorClass = 'text-red-600';
      if (statusText === 'Manutenção') statusColorClass = 'text-yellow-600';
      statusContainer.innerHTML = `<span class="font-semibold ${statusColorClass}">${statusText}</span>`;
    }
  }

  function toggleAddMode(){ 
    isAddMode = !isAddMode;
    addPrinterBtn.classList.toggle('bg-[#81B29A]', !isAddMode);
    addPrinterBtn.classList.toggle('bg-yellow-500', isAddMode);
    mapContainer.classList.toggle('add-mode', isAddMode);
    mapContainer.classList.toggle('border-yellow-500', isAddMode);
    mapContainer.classList.toggle('border-transparent', !isAddMode);
    if (isAddMode) {
        showToast('Clique no mapa para posicionar a nova impressora.');
    }
  }

  mapContainer.addEventListener('click', (event) => {
    if (event.target.closest('.printer-point')) return;
    const rect = mapContainer.getBoundingClientRect();
    const coords = { 
        top: `${((event.clientY - rect.top) / rect.height) * 100}%`, 
        left: `${((event.clientX - rect.left) / rect.width) * 100}%` 
    };

    // Se estivermos reposicionando uma impressora existente
    if (isAddMode && repositionTargetSelb) {
      const p = printerData.find(p => p.selb === repositionTargetSelb);
      if (p) {
        p.pos = coords;
        savePrinters();
        renderAllPrinters();
        showToast('Posição da impressora atualizada.');
      }
      repositionTargetSelb = null;
      toggleAddMode();
      return;
    }

    // Fluxo normal de adição
    if (!isAddMode) return;
    newPrinterCoords = coords;
    addPrinterForm.reset();
    // garantir que o formulário esteja no modo de adicionar (não editar)
    delete addModal.dataset.editingSelb;
    addModalTitle.textContent = 'Adicionar Nova Impressora';
    addSubmitBtn.textContent = 'Salvar Impressora';
    addModal.classList.remove('hidden');
    toggleAddMode();
  });

  addPrinterForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(addPrinterForm);
    const name = (formData.get('name') || '').trim();
    const department = (formData.get('department') || '').trim();
    const selb = (formData.get('selb') || '').trim();
    const ip = (formData.get('ip') || '').trim();

    if (!name || !department || !selb || !ip) {
      showToast('Preencha todos os campos.');
      return;
    }

    const editingSelb = addModal.dataset.editingSelb;
    if (editingSelb) {
      // editar impressora existente
      const idx = printerData.findIndex(p => p.selb === editingSelb);
      if (idx === -1) {
        showToast('Erro: impressora não encontrada.');
        addModal.classList.add('hidden');
        return;
      }
      // se alterou o SELB para um que já existe em outra impressora
      if (selb !== editingSelb && printerData.some(p => p.selb === selb)) {
        showToast('Erro: já existe outra impressora com esse SELB.');
        return;
      }

      printerData[idx].name = name;
      printerData[idx].department = department;
      printerData[idx].selb = selb;
      printerData[idx].ip = ip;
      // posição já estava em newPrinterCoords caso o usuário tenha escolhido um novo local via reposicionar
      printerData[idx].pos = newPrinterCoords || printerData[idx].pos;

      savePrinters();
      renderAllPrinters();
      addModal.classList.add('hidden');
      detailsModal.classList.add('hidden');
      delete addModal.dataset.editingSelb;
      showToast('Impressora atualizada com sucesso.');
      return;
    }

    // adicionar nova impressora
    if (printerData.some(p => p.selb === selb)) {
      showToast('Erro: já existe uma impressora com esse SELB.');
      return;
    }

    const newPrinter = {
        name,
        department,
        selb,
        ip,
        status: 'Desconhecido',
        pos: newPrinterCoords
    };
    printerData.push(newPrinter);
    savePrinters();
    createPrinterPoint(newPrinter);
    addModal.classList.add('hidden');
    showToast('Impressora adicionada com sucesso.');
  });

  addHitbox.addEventListener('click', (e)=>{ e.stopPropagation(); toggleAddMode(); });
  
  searchHitbox.addEventListener('click', (e) => {
    e.stopPropagation();
    searchContainer.classList.toggle('expanded');
    if (searchContainer.classList.contains('expanded')) {
        searchInput.focus();
    } else {
        searchResultsPanel.style.display = 'none';
        searchInput.value = '';
    }
  });

  document.addEventListener('click', (e)=>{ 
      if (!searchContainer.contains(e.target)) { 
          searchContainer.classList.remove('expanded'); 
          searchResultsPanel.style.display='none';
      } 
  });

  searchForm.addEventListener('submit', (e) => { e.preventDefault(); handleSearch(); });
  searchInput.addEventListener('input', handleSearch);

  function handleSearch() {
    const term = searchInput.value.toLowerCase().trim();
    document.querySelectorAll('.printer-point').forEach(p=>p.classList.remove('highlighted'));
    if (!term) {
        searchResultsPanel.style.display = 'none';
        return;
    }
    const results = printerData.filter(p => p.name.toLowerCase().includes(term) || p.selb.toLowerCase().includes(term));
    
    searchResultsPanel.innerHTML = '';
    if (!results.length) {
        searchResultsPanel.innerHTML = '<div class="p-3 text-center text-gray-500">Nenhum resultado.</div>';
    } else {
        results.forEach(r => {
            const d = document.createElement('div');
            d.className = 'result-item p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50';
            d.innerHTML = `<div class="font-semibold">${r.name}</div><div class="text-sm text-gray-500">SELB: ${r.selb}</div>`;
            d.addEventListener('click', (ev) => {
                ev.stopPropagation();
                searchResultsPanel.style.display = 'none';
                searchContainer.classList.remove('expanded');
                searchInput.value = r.name;
                focusPrinter(r, true);
            });
            searchResultsPanel.appendChild(d);
        });
    }
    searchResultsPanel.style.display = 'block';
  }

  // --- CORREÇÃO: função de foco/zoom centralizada ---
  function focusPrinter(printer, openModal = false) {
    if (focusResetTimer) clearTimeout(focusResetTimer);
    if (transientLabel) transientLabel.remove();
    
    document.querySelectorAll('.printer-point').forEach(p => p.classList.remove('highlighted'));
    const point = document.querySelector(`.printer-point[data-printer-selb="${printer.selb}"]`);
    if (!point) return;

    point.classList.add('highlighted');

    const pRect = point.getBoundingClientRect();
    const mapRect = mapContainer.getBoundingClientRect();

    // centro do ponto relativo ao container (em px)
    const pCenterX = (pRect.left - mapRect.left) + pRect.width / 2;
    const pCenterY = (pRect.top - mapRect.top) + pRect.height / 2;

    const scale = 1.4;

    // depois de escalar, queremos que (pCenterX * scale, pCenterY * scale) fique no centro do container
    let dx = mapRect.width / 2 - pCenterX * scale;
    let dy = mapRect.height / 2 - pCenterY * scale;

    // Opcional: limita a tradução para não mostrar áreas vazias além da imagem (ajuste margem se quiser)
    // Calcula tamanho do mapa escalado (aprox. pelo container)
    const scaledWidth = mapRect.width * scale;
    const scaledHeight = mapRect.height * scale;
    // limites (em px) para dx/dy: evitar mover o mapa para revelar fundo vazio
    const maxDx = 0;
    const minDx = mapRect.width - scaledWidth;
    const maxDy = 0;
    const minDy = mapRect.height - scaledHeight;
    dx = Math.min(maxDx, Math.max(minDx, dx));
    dy = Math.min(maxDy, Math.max(minDy, dy));

    mapInner.style.transform = `scale(${scale}) translate(${dx}px, ${dy}px)`;

    // Scroll para centralizar o container no viewport
    const containerRectAfter = mapContainer.getBoundingClientRect();
    const scrollLeft = window.scrollX + containerRectAfter.left - (window.innerWidth - containerRectAfter.width) / 2;
    const scrollTop = window.scrollY + containerRectAfter.top - (window.innerHeight - containerRectAfter.height) / 2;
    window.scrollTo({ left: scrollLeft, top: scrollTop, behavior: 'smooth' });

    transientLabel = document.createElement('div');
    transientLabel.className = 'focus-label';
    transientLabel.innerHTML = `${printer.name} <span class="font-normal text-xs text-gray-500 ml-2">(${printer.selb})</span>`;
    transientLabel.style.left = `50%`;
    transientLabel.style.top = `50%`;
    transientLabel.style.transform = `translate(-50%, calc(-100% - 20px))`;
    mapContainer.appendChild(transientLabel);

    focusResetTimer = setTimeout(() => {
        mapInner.style.transform = '';
        point.classList.remove('highlighted');
        if (transientLabel) {
            transientLabel.remove();
            transientLabel = null;
        }
    }, 6500);

    if (openModal) {
      setTimeout(() => {
          const current = printerData.find(p => p.selb === printer.selb);
          if (current) {
              showDetailsModal(current);
              checkPrinterReachabilityAndUpdate(current);
          }
      }, 500);
    }
  }

  deletePrinterBtn.addEventListener('click', () => {
    printerData = printerData.filter(p => p.selb !== printerToDeleteSelb);
    savePrinters();
    renderAllPrinters();
    detailsModal.classList.add('hidden');
    showToast('Impressora removida com sucesso!');
  });

  editPrinterBtn.addEventListener('click', () => {
    const selb = printerToDeleteSelb;
    const p = printerData.find(x => x.selb === selb);
    if (!p) return showToast('Impressora não encontrada.');

    // abrir modal de adicionar já preenchido no modo edição
    addPrinterForm.reset();
    addPrinterForm.querySelector('[name="name"]').value = p.name;
    addPrinterForm.querySelector('[name="department"]').value = p.department;
    addPrinterForm.querySelector('[name="selb"]').value = p.selb;
    addPrinterForm.querySelector('[name="ip"]').value = p.ip;
    newPrinterCoords = p.pos || newPrinterCoords;

    addModal.dataset.editingSelb = p.selb;
    addModalTitle.textContent = 'Editar Impressora';
    addSubmitBtn.textContent = 'Salvar Alterações';
    detailsModal.classList.add('hidden');
    addModal.classList.remove('hidden');
  });

  repositionPrinterBtn.addEventListener('click', () => {
    const selb = printerToDeleteSelb;
    const p = printerData.find(x => x.selb === selb);
    if (!p) return showToast('Impressora não encontrada.');
    repositionTargetSelb = selb;
    // entrar em modo de adicionar para capturar o clique no mapa
    if (!isAddMode) toggleAddMode();
    detailsModal.classList.add('hidden');
    showToast('Clique no mapa para reposicionar a impressora selecionada.');
  });

  document.querySelectorAll('.close-modal-btn').forEach(b => b.addEventListener('click', () => {
    detailsModal.classList.add('hidden');
    addModal.classList.add('hidden');
    // cancelar edição caso estava em modo edição
    delete addModal.dataset.editingSelb;
  }));
  
  document.addEventListener('keydown', (e) => {
      if (e.key === "Escape") {
          detailsModal.classList.add('hidden');
          addModal.classList.add('hidden');
          searchResultsPanel.style.display = 'none';
          if (searchContainer.classList.contains('expanded')) {
              searchContainer.classList.remove('expanded');
              searchInput.value = '';
          }
          delete addModal.dataset.editingSelb;
      }
  });

  loadPrinters();
});
</script>

</body>
</html>
